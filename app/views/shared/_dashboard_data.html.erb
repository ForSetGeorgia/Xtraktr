<%- 
  model_class = Dataset 
  r_model_class = Report 
  is_admin_page = request.path == dataset_path(@dataset)

  subnav_left render(partial: 'shared/language_switcher', locals: {langs: @dataset.language_objects, current_locale: @dataset.current_locale})

-%>
<div class="article dashboard">
  <div class="meta">
    <div class="col bright">
      <h2><%=@dataset.title%></h2>
      <div class="info">
        <div class="calendar"></div>
        <div class="timestamp">
          <span><%= model_class.human_attribute_name(:gathered_at) %>:</span>
          <%= format_gathered_dates(@dataset.start_gathered_at, @dataset.end_gathered_at) %>
        </div>
        <div class="timestamp">
          <span><%= model_class.human_attribute_name(:released_at) %>::</span>
          <%= I18n.l(@dataset.released_at, format: :day_first) if @dataset.released_at.present? %>
        </div>   
        <div class="share"><div class="prompt"><%= t('app.common.share') %></div><div class="addthis_sharing_toolbox"></div></div>
      </div>
      
      <% if @is_xtraktr %>
        <div class="source"><%= "#{model_class.human_attribute_name(:source)}: #{@dataset.source}" %></div>
      <% end %>
      <% if @dataset.description.present? %>
        <div class="description">
          <%= simple_format_no_tags(@dataset.description, {}, {sanitize: false}) %>
        </div>
      <% end %>
    </div>
    <div class="col">
      <% if @dataset.categories.present? %>
        <div class="category">
          <ul>
            <% @dataset.categories.each {|x| %>
              <li class="item">
                <div class="text"><span><%= x.name %></span></div>
                <div class="img <%= x.permalink %>" alt="<%= x.name %>"></div>
              </li>
            <% } %>
          </ul>         
        </div>
      <% end %>
      <div class="links">
        <%= link_to url_dataset_explore(@dataset, language: params[:language]), title: t('app.menu.titles.explore_dataset') do %>
            <%= image_tag 'svg/chart.svg' %>
            <%= t('app.menu.explore_data') %>
        <% end %>

        <% if @dataset.time_series_datasets.present? %>
          <%= link_to url_dataset_to_times_series_dashboard(@dataset.id, @dataset.time_series_datasets.first.time_series_id),  title: t('app.menu.titles.dataset_to_time_series') do %>
            <%= image_tag 'svg/timeseries.svg' %>
            <%= t('app.menu.time_series') %>
          <% end %>
        <% end %>                    
        <% if @dataset.urls.present? && @dataset.urls.codebook.present? %>     
            <div class="download-wrapper" >
              <div class="download" data-id="<%= @dataset.id.to_s %>" data-lang="<%= @dataset.current_locale %>">
              <%= image_tag 'svg/download_big.svg', alt: t('helpers.links.download_data') %>
              <%= t('helpers.links.download_data') %>
              <ul>
                <li><div class="type" data-type='csv' title="<%= t('download_data_options.title.csv') %>" data-placement="left"><%= t('download_data_options.text.csv') %></div></li>
                <li><div class="type" data-type='r' title="<%= t('download_data_options.title.r') %>" data-placement="left"><%= t('download_data_options.text.r') %></div></li>
                <li><div class="type" data-type='spss' title="<%= t('download_data_options.title.spss') %>" data-placement="left"><%= t('download_data_options.text.spss') %></div></li>
                <li><div class="type" data-type='stata' title="<%= t('download_data_options.title.stata') %>" data-placement="left"><%= t('download_data_options.text.stata') %></div></li>
              </ul>                 
            </div>        
          </div>
        <% end %>
     
      </div>
    </div>
  </div>

<div id="dashboard-tabs" class="tabs" role="tabpanel">
    <% 
      highlight_active = {tab: '', panel: ''}
      method_active = {tab: 'active', panel: 'in active'}
      codebook_active = {tab: '', panel: ''}
      if @highlights.present?
        highlight_active = {tab: 'active', panel: 'in active'}
        method_active = {tab: '', panel: ''}
      elsif !@dataset.methodology.present? 
        method_active = {tab: '', panel: ''}
        codebook_active = {tab: 'active', panel: 'in active'}
      end 
    %>

  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="<%= highlight_active[:tab] %>">
      <a href="#highlights" aria-controls="highlights" role="tab" data-toggle="tab"><%= t('.tabs.highlights') %></a>
    </li>
    <li role="presentation" class="<%= method_active[:tab] %>">
      <a href="#methodology" aria-controls="methodology" role="tab" data-toggle="tab"><%= t('.tabs.methodology') %></a>
    </li>
    <li role="presentation" class="<%= codebook_active[:tab] %>">
      <a href="#codebook" aria-controls="codebook" role="tab" data-toggle="tab"><%= t('.tabs.codebook') %></a>
    </li>
    <li role="presentation">
      <a href="#reports" aria-controls="reports" role="tab" data-toggle="tab"><%= t('.tabs.reports') %></a>
    </li>
    <li role="presentation">
      <a href="#licensing" aria-controls="licensing" role="tab" data-toggle="tab"><%= t('.tabs.licensing') %></a>
    </li>
  </ul>

  <div class="tab-content">
    <div role="tabpanel" class="tab-pane fade <%= highlight_active[:panel] %>" id="highlights">
      <% if @highlights.present? %>
        <% @highlights.shuffle.each do |highlight| %>
          <div class="highlight <%= highlight.visual_type_name %>">
            <iframe src="<%= embed_v1_path(id: highlight.embed_id, exclude_title: true) %>"></iframe>
          </div>
        <% end %>
      <% else %>
        <p>
          <%= t('.no_highlights') %>
        </p>
      <% end %>
    </div>
    
    <div role="tabpanel" class="tab-pane fade <%= method_active[:panel] %>" id="methodology">
      <% if @dataset.methodology.present? %>
        <div class="tinymce_format">
          <%= simple_format_no_tags(@dataset.methodology, {}, {sanitize: false}) %>
        </div>
      <% else %>
        <p>
          <%= t('.no_methodology') %>
        </p>
      <% end %>
    </div>
    
    <div role="tabpanel" class="tab-pane fade <%= codebook_active[:panel] %>" id="codebook">
      <div id="codebook-search">

        <input type="text" class="text-input col-sm-3" id="filter" class="form-control" value="" placeholder="<%= t('helpers.search') %>" />

        <label class="filter" for="filter_all">
          <input checked id="filter_all" name="filter" type="radio" value="all" />
          <%= t('.filter.all') %>
        </label>
        <label class="filter" for="filter_q">
          <input id="filter_q" name="filter" type="radio" value="q" />
          <%= t('.filter.questions') %>
        </label>
        <label class="filter" for="filter_ans">
          <input id="filter_ans" name="filter" type="radio" value="ans" />
          <%= t('.filter.answers') %>
        </label>
        <%= link_to @dataset.urls.codebook, class: 'download-direct',  title: t("app.common.codebook_title") do %>
                  <% end %>   
      </div>
      <ul class="list-unstyled">
        <% @dataset.questions.for_analysis.each do |question| %>
          <li class="row">
            <div class="col-sm-4 question">
              <h3>
                <%= link_to url_dataset_explore(@dataset, question_code: question.code, language: params[:language]) do %>
                  <span><%= question.original_code %>:</span>
                  <%= question.text %>
                <% end %>
              </h3>

            </div>
            <div class="col-sm-8 details">
              <div class="row question-row">
                <div class="col-sm-1 headers">
                  <%= t('app.common.question') %>:                  
                </div>
                <div class="col-sm-11">
                  <%= question.text %>
                </div>
              </div>
              <% if question.notes.present? %>
                <div class="row notes-row">
                  <div class="col-sm-1 headers">
                    <%= t('app.common.notes') %>:                  
                  </div>
                  <div class="col-sm-11">
                    <%= question.notes %>
                  </div>
                </div>
              <% end %>
              <div class="row answer-row">
                <div class="col-sm-1 headers">
                  <%= t('app.common.answers') %>:                  
                </div>
                <div class="col-sm-11">
                  <%
                    answers = question.answers.all_for_analysis
                    if answers.present? 
                  %>
                    <ul>
                      <% answers.each do |answer| %>
                        <li>
                        <%= answer.text %>
                        </li> 
                      <% end %>
                    </ul>
                  <% end %>
                </div>
              </div>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
    
    <div role="tabpanel" class="tab-pane fade list" id="reports">
      <ul>
        <% if @dataset.reports.present? %>
          <% @dataset.reports.sorted.each do |report| %>
            <li>
              <h2><%= report.title %></h2>
                  <%= link_to report.file.url, class: 'download-direct', target: :blank, title: "#{report.file_type} - #{number_to_human_size(report.file_file_size).to_s}" do %>
                  <% end %>                  
              <div class="info">
                <div class="calendar"></div>
                <div class="timestamp"><span><%= "#{r_model_class.human_attribute_name(:released_at)}:"%></span> <%= "#{l report.released_at, format: :day_first}" %></div>
                <% if report.language.present? %>
                  <div class="language"><span><%= "#{r_model_class.human_attribute_name(:language_id)}:"%></span> <%= "#{report.language.name}" %></div>
                <% end %>
              <% if report.summary.present? %>
                <div class="description"><%= simple_format(report.summary, {}, {sanitize: false}) %></div>
              <% end %>
            </li>
          <% end %>
        <% else %>
          <li><div class="no-data-found"> <%= t('.no_reports') %></div></li>
        <% end %>
       </ul>
    </div>

    <div role="tabpanel" class="tab-pane fade" id="licensing">
      <% if @license.present? %>
        <div class="tinymce_format">
          <%= simple_format_no_tags(@license.content, {}, {sanitize: false}) %>
        </div>
      <% else %>
        comming soon...
      <% end %>
    </div>
  </div>

</div>
</div>

<%
  addthis_id =  @is_xtraktr ? (Rails.env.production? ? ENV['XTRAKTR_ADDTHIS_PROFILE_ID'] : ENV['XTRAKTR_ADDTHIS_PROFILE_ID_DEV']) 
                            : (Rails.env.production? ? ENV['UNICEF_ADDTHIS_PROFILE_ID']  : ENV['UNICEF_ADDTHIS_PROFILE_ID_DEV'])
  if addthis_id.present?
%>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=<%= addthis_id %>" async="async"></script>
<% end %>